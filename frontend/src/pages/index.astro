---
// Council1901 â€“ single-page app
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Council1901 â€“ Private Diplomacy</title>
    <style is:global>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --bg: #f5f0e8;
        --surface: #ede8dc;
        --card: #faf6ef;
        --accent: #5a3e28;
        --text: #2c1f0e;
        --muted: #7a6a55;
        --border: #c8bfad;
        --success: #3a6e42;
        --radius: 6px;
        --font: 'Segoe UI', system-ui, sans-serif;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font);
        height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      /* ===== Header ===== */
      header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-shrink: 0;
      }

      header h1 {
        font-size: 1.1rem;
        letter-spacing: 0.05em;
        color: var(--accent);
      }

      #header-info {
        flex: 1;
        font-size: 0.82rem;
        color: var(--muted);
      }

      #btn-logout {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 4px 12px;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.82rem;
      }
      #btn-logout:hover { border-color: var(--accent); color: var(--accent); }

      /* ===== Auth Screen ===== */
      #auth-screen {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .auth-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 40px 36px;
        width: 360px;
      }

      .auth-card h2 {
        margin-bottom: 6px;
        font-size: 1.3rem;
      }

      .auth-card p {
        color: var(--muted);
        font-size: 0.85rem;
        margin-bottom: 28px;
      }

      label {
        display: block;
        font-size: 0.8rem;
        color: var(--muted);
        margin-bottom: 4px;
        margin-top: 14px;
      }

      input, select {
        width: 100%;
        padding: 9px 12px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.92rem;
      }
      input:focus, select:focus { outline: none; border-color: var(--accent); }

      .btn-primary {
        margin-top: 22px;
        width: 100%;
        padding: 10px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        font-size: 0.95rem;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-primary:hover { opacity: 0.9; }
      .btn-primary:disabled { opacity: 0.5; cursor: default; }

      .error-msg {
        margin-top: 12px;
        color: var(--accent);
        font-size: 0.82rem;
        min-height: 18px;
      }

      /* ===== Room Screen ===== */
      #room-screen {
        flex: 1;
        display: none;
        overflow: hidden;
      }

      .room-layout {
        display: flex;
        height: 100%;
      }

      /* Sidebar */
      .sidebar {
        width: 230px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sidebar-header span {
        font-size: 0.78rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      #btn-new-conv {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        width: 24px;
        height: 24px;
        font-size: 1.2rem;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #btn-new-conv:hover { opacity: 0.85; }

      #conv-list {
        flex: 1;
        overflow-y: auto;
        padding: 6px 0;
      }

      .conv-item {
        padding: 10px 14px;
        cursor: pointer;
        border-left: 3px solid transparent;
        font-size: 0.85rem;
      }
      .conv-item:hover { background: rgba(0,0,0,0.05); }
      .conv-item.active {
        background: rgba(90,62,40,0.1);
        border-left-color: var(--accent);
      }

      .conv-participants {
        color: var(--text);
        font-weight: 500;
      }

      /* Main chat area */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-placeholder {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.9rem;
      }

      #chat-header {
        padding: 12px 18px;
        border-bottom: 1px solid var(--border);
        font-size: 0.88rem;
        color: var(--muted);
        flex-shrink: 0;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .msg {
        padding: 10px 14px;
        border-radius: 4px;
        font-size: 0.88rem;
        line-height: 1.5;
        background: var(--card);
        border: 1px solid var(--border);
        border-left: 3px solid var(--country-color, var(--accent));
      }

      .msg-sender {
        font-size: 0.72rem;
        color: var(--country-color, var(--accent));
        margin-bottom: 3px;
        font-weight: 700;
        text-transform: capitalize;
      }

      .msg-time {
        font-size: 0.68rem;
        color: var(--muted);
        margin-top: 4px;
      }

      #send-form {
        padding: 12px 18px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 10px;
        flex-shrink: 0;
      }

      #send-form input {
        flex: 1;
      }

      #send-form button {
        padding: 9px 18px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.88rem;
        font-weight: 600;
        white-space: nowrap;
      }
      #send-form button:hover { opacity: 0.9; }
      #send-form button:disabled { opacity: 0.4; cursor: default; }

      /* ===== New Conversation Modal ===== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      .modal-overlay.open { display: flex; }

      .modal {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 28px 28px 24px;
        width: 340px;
      }

      .modal h3 { margin-bottom: 6px; }
      .modal p { color: var(--muted); font-size: 0.82rem; margin-bottom: 18px; }

      .country-checkboxes {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 18px;
      }

      .country-checkboxes label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        margin: 0;
        font-size: 0.9rem;
        color: var(--text);
        text-transform: capitalize;
      }

      .country-checkboxes input[type=checkbox] {
        width: auto;
        accent-color: var(--accent);
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .btn-secondary {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.88rem;
      }
      .btn-secondary:hover { border-color: var(--muted); color: var(--text); }

      .btn-create {
        padding: 8px 16px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.88rem;
        font-weight: 600;
      }
      .btn-create:hover { opacity: 0.9; }
      .btn-create:disabled { opacity: 0.4; cursor: default; }

      #modal-error {
        color: var(--accent);
        font-size: 0.8rem;
        min-height: 16px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>âš” Council1901</h1>
      <span id="header-info"></span>
      <button id="btn-logout" style="display:none">Logout</button>
    </header>

    <!-- Auth Screen -->
    <div id="auth-screen">
      <div class="auth-card">
        <h2>Join a room</h2>
        <p>Enter your room ID and select your country to begin secret negotiations.</p>
        <form id="auth-form">
          <label for="room-id">Room ID</label>
          <input id="room-id" type="text" placeholder="e.g. spring-1901" maxlength="64" required />

          <label for="country-select">Country</label>
          <select id="country-select" required>
            <option value="">â€” Select â€”</option>
            <option value="england">England</option>
            <option value="france">France</option>
            <option value="germany">Germany</option>
            <option value="italy">Italy</option>
            <option value="austria">Austria</option>
            <option value="russia">Russia</option>
            <option value="turkey">Turkey</option>
          </select>

          <div class="error-msg" id="auth-error"></div>
          <button class="btn-primary" type="submit">Enter Room</button>
        </form>
      </div>
    </div>

    <!-- Room Screen -->
    <div id="room-screen">
      <div class="room-layout">
        <aside class="sidebar">
          <div class="sidebar-header">
            <span>Conversations</span>
            <button id="btn-new-conv" title="New conversation">+</button>
          </div>
          <div id="conv-list">
            <!-- Populated by JS -->
          </div>
        </aside>

        <div class="chat-area">
          <div class="chat-placeholder" id="chat-placeholder">Select a conversation</div>

          <div id="chat-header" style="display:none"></div>
          <div id="messages" style="display:none"></div>

          <form id="send-form" style="display:none">
            <input type="text" id="msg-input" placeholder="Write a messageâ€¦" maxlength="4096" autocomplete="off" />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>

    <!-- New Conversation Modal -->
    <div class="modal-overlay" id="new-conv-modal">
      <div class="modal">
        <h3>New conversation</h3>
        <p>Select 1 or 2 other countries to invite (you are automatically included).</p>
        <div class="country-checkboxes" id="modal-countries">
          <!-- Populated by JS -->
        </div>
        <div id="modal-error"></div>
        <div class="modal-actions">
          <button class="btn-secondary" id="btn-modal-cancel">Cancel</button>
          <button class="btn-create" id="btn-modal-create">Create</button>
        </div>
      </div>
    </div>

    <script>
      const COUNTRIES = ['england','france','germany','italy','austria','russia','turkey'];
      const COUNTRY_COLORS = {
        england: '#8b1a1a',
        france:  '#1a3a8b',
        germany: '#333333',
        italy:   '#1a7a1a',
        austria: '#8b4513',
        russia:  '#4a4a8b',
        turkey:  '#8b7000',
      };
      const STORAGE_KEY = 'council1901_auth';
      const POLL_INTERVAL = 3000;

      // ===== State =====
      let state = {
        token: null,
        roomId: null,
        country: null,
        conversations: [],
        activeConvId: null,
        messages: [],
        lastTimestamp: 0,
        pollTimer: null,
      };

      // ===== DOM refs =====
      const $authScreen   = document.getElementById('auth-screen');
      const $roomScreen   = document.getElementById('room-screen');
      const $headerInfo   = document.getElementById('header-info');
      const $btnLogout    = document.getElementById('btn-logout');
      const $authForm     = document.getElementById('auth-form');
      const $authError    = document.getElementById('auth-error');
      const $convList     = document.getElementById('conv-list');
      const $btnNewConv   = document.getElementById('btn-new-conv');
      const $modal        = document.getElementById('new-conv-modal');
      const $modalCountries = document.getElementById('modal-countries');
      const $modalError   = document.getElementById('modal-error');
      const $btnModalCancel = document.getElementById('btn-modal-cancel');
      const $btnModalCreate = document.getElementById('btn-modal-create');
      const $chatPlaceholder = document.getElementById('chat-placeholder');
      const $chatHeader   = document.getElementById('chat-header');
      const $messages     = document.getElementById('messages');
      const $sendForm     = document.getElementById('send-form');
      const $msgInput     = document.getElementById('msg-input');

      // ===== Helpers =====
      function authHeaders() {
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.token}` };
      }

      function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

      function formatTime(ts) {
        return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // ===== Auth =====
      async function doAuth(roomId, country) {
        const resp = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room_id: roomId, country }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || resp.statusText);
        }
        const { access_token } = await resp.json();
        state.token = access_token;
        state.roomId = roomId;
        state.country = country;
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ token: access_token, roomId, country }));
        showRoom();
      }

      function logout() {
        if (state.pollTimer) clearInterval(state.pollTimer);
        localStorage.removeItem(STORAGE_KEY);
        state = { token: null, roomId: null, country: null, conversations: [], activeConvId: null, messages: [], lastTimestamp: 0, pollTimer: null };
        showAuth();
      }

      // ===== Screen switching =====
      function showAuth() {
        $authScreen.style.display = 'flex';
        $roomScreen.style.display = 'none';
        $btnLogout.style.display = 'none';
        $headerInfo.textContent = '';
      }

      function showRoom() {
        $authScreen.style.display = 'none';
        $roomScreen.style.display = 'block';
        $btnLogout.style.display = 'inline-block';
        $headerInfo.textContent = `Room: ${state.roomId}  Â·  You: ${capitalize(state.country)}`;
        loadConversations();
        if (state.pollTimer) clearInterval(state.pollTimer);
        state.pollTimer = setInterval(poll, POLL_INTERVAL);
      }

      // ===== Conversations =====
      async function loadConversations() {
        try {
          const resp = await fetch(`/api/conversations?room_id=${encodeURIComponent(state.roomId)}`, {
            headers: authHeaders(),
          });
          if (resp.status === 401) { logout(); return; }
          if (!resp.ok) return;
          state.conversations = await resp.json();
          renderConversations();
        } catch (_) {}
      }

      function renderConversations() {
        $convList.innerHTML = '';
        if (state.conversations.length === 0) {
          $convList.innerHTML = '<div style="padding:14px;font-size:0.8rem;color:var(--muted)">No conversations yet</div>';
          return;
        }
        for (const conv of state.conversations) {
          const others = conv.participants.filter(p => p !== state.country);
          const label = others.map(capitalize).join(' Â· ');
          const div = document.createElement('div');
          div.className = 'conv-item' + (conv.conversation_id === state.activeConvId ? ' active' : '');
          div.innerHTML = `<div class="conv-participants">${label}</div>`;
          div.addEventListener('click', () => selectConversation(conv.conversation_id));
          $convList.appendChild(div);
        }
      }

      async function selectConversation(convId) {
        state.activeConvId = convId;
        state.messages = [];
        state.lastTimestamp = 0;
        renderConversations();

        const conv = state.conversations.find(c => c.conversation_id === convId);
        if (conv) {
          const participants = conv.participants.map(capitalize).join(', ');
          $chatHeader.textContent = `ðŸ”’ ${participants}`;
          $chatHeader.style.display = 'block';
        }
        $messages.style.display = 'flex';
        $messages.innerHTML = '';
        $sendForm.style.display = 'flex';
        $chatPlaceholder.style.display = 'none';
        await fetchMessages(convId);
      }

      // ===== Messages =====
      async function fetchMessages(convId) {
        try {
          const url = `/api/messages?conversation_id=${encodeURIComponent(convId)}&since=${state.lastTimestamp}`;
          const resp = await fetch(url, { headers: authHeaders() });
          if (resp.status === 401) { logout(); return; }
          if (!resp.ok) return;
          const newMsgs = await resp.json();
          if (newMsgs.length > 0) {
            state.messages = state.lastTimestamp === 0
              ? newMsgs
              : [...state.messages, ...newMsgs];
            state.lastTimestamp = newMsgs[newMsgs.length - 1].timestamp;
            renderMessages();
          }
        } catch (_) {}
      }

      function renderMessages() {
        $messages.innerHTML = '';
        for (const msg of state.messages) {
          const div = document.createElement('div');
          const mine = msg.sender_country === state.country;
          const color = COUNTRY_COLORS[msg.sender_country] || 'var(--accent)';
          div.className = 'msg';
          div.style.setProperty('--country-color', color);
          div.innerHTML = `
            <div class="msg-sender">${capitalize(msg.sender_country)}${mine ? ' (You)' : ''}</div>
            <div class="msg-text">${escapeHtml(msg.content)}</div>
            <div class="msg-time">${formatTime(msg.timestamp)}</div>
          `;
          $messages.appendChild(div);
        }
        $messages.scrollTop = $messages.scrollHeight;
      }

      function escapeHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      // ===== Poll =====
      function poll() {
        if (state.activeConvId) fetchMessages(state.activeConvId);
        else loadConversations();
      }

      // ===== New Conversation Modal =====
      function openModal() {
        $modalCountries.innerHTML = '';
        $modalError.textContent = '';
        for (const c of COUNTRIES) {
          if (c === state.country) continue;
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" value="${c}" /> ${capitalize(c)}`;
          $modalCountries.appendChild(label);
        }
        $modal.classList.add('open');
      }

      function closeModal() {
        $modal.classList.remove('open');
      }

      async function createConversation() {
        const checked = [...$modalCountries.querySelectorAll('input:checked')].map(i => i.value);
        if (checked.length < 1 || checked.length > 2) {
          $modalError.textContent = 'Select 1 or 2 other countries.';
          return;
        }
        const participants = [state.country, ...checked];
        $btnModalCreate.disabled = true;
        $modalError.textContent = '';
        try {
          const resp = await fetch('/api/conversations', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ room_id: state.roomId, participants }),
          });
          if (!resp.ok) {
            $modalError.textContent = await resp.text();
            return;
          }
          const { conversation_id } = await resp.json();
          closeModal();
          await loadConversations();
          await selectConversation(conversation_id);
        } catch (e) {
          $modalError.textContent = e.message;
        } finally {
          $btnModalCreate.disabled = false;
        }
      }

      // ===== Event listeners =====
      $authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        $authError.textContent = '';
        const roomId = document.getElementById('room-id').value.trim();
        const country = document.getElementById('country-select').value;
        const btn = $authForm.querySelector('button[type=submit]');
        btn.disabled = true;
        try {
          await doAuth(roomId, country);
        } catch (err) {
          $authError.textContent = err.message;
        } finally {
          btn.disabled = false;
        }
      });

      $btnLogout.addEventListener('click', logout);
      $btnNewConv.addEventListener('click', openModal);
      $btnModalCancel.addEventListener('click', closeModal);
      $btnModalCreate.addEventListener('click', createConversation);
      $modal.addEventListener('click', (e) => { if (e.target === $modal) closeModal(); });

      $sendForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = $msgInput.value.trim();
        if (!content || !state.activeConvId) return;
        $msgInput.value = '';
        const btn = $sendForm.querySelector('button[type=submit]');
        btn.disabled = true;
        try {
          const resp = await fetch('/api/messages', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ conversation_id: state.activeConvId, content }),
          });
          if (resp.status === 401) { logout(); return; }
          if (resp.ok) await fetchMessages(state.activeConvId);
        } finally {
          btn.disabled = false;
          $msgInput.focus();
        }
      });

      // ===== Init =====
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const { token, roomId, country } = JSON.parse(stored);
          if (token && roomId && country) {
            state.token = token;
            state.roomId = roomId;
            state.country = country;
            showRoom();
          } else {
            showAuth();
          }
        } catch (_) {
          showAuth();
        }
      } else {
        showAuth();
      }
    </script>
  </body>
</html>
